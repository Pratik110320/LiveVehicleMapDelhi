<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delhi Live Bus Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        .leaflet-container { height: 100vh; width: 100%; background-color: #f0f2f5; }
        .sidebar { transition: transform 300ms cubic-bezier(0.4, 0, 0.2, 1); }
        .bus-marker {
            display: flex; align-items: center; justify-content: center;
            width: 32px; height: 32px; background-color: #1a73e8;
            color: white; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 2px solid white; font-size: 12px; font-weight: 700;
            transition: transform 0.2s ease;
        }
        .bus-marker.selected {
            transform: scale(1.3);
            background-color: #fbbc05;
            z-index: 1000 !important;
        }
        .stop-marker-icon {
            background-color: #fff; border: 2px solid #5f6368;
            border-radius: 50%; width: 8px; height: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .stop-marker-icon.highlighted {
            background-color: #1a73e8; border-color: #fff; transform: scale(1.5);
        }
        .stop-marker-icon.selected {
            background-color: #fbbc05; border: 2px solid #fff; transform: scale(2);
        }
        .loader {
            border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #1a73e8;
            width: 30px; height: 30px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sidebar-content { scrollbar-width: thin; scrollbar-color: #a0aec0 #edf2f7; }
        .sidebar-content::-webkit-scrollbar { width: 6px; }
        .sidebar-content::-webkit-scrollbar-track { background: #edf2f7; }
        .sidebar-content::-webkit-scrollbar-thumb { background-color: #a0aec0; border-radius: 10px; border: 3px solid #edf2f7; }
        .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
        	background-color: rgba(26, 115, 232, 0.7);
        }
        .marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div {
        	background-color: rgba(26, 115, 232, 0.9);
            color: #fff; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .status-indicator {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            display: flex; align-items: center; background-color: white;
            padding: 5px 10px; border-radius: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            cursor: default;
        }
        .status-dot {
            width: 12px; height: 12px; border-radius: 50%;
            margin-right: 8px; transition: background-color 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100">
<div id="root"></div>
<script type="text/babel">
    const { useState, useEffect, useRef, useCallback, useMemo } = React;

    const StatusIndicator = ({ status }) => {
        const statusConfig = {
            connecting: { color: 'bg-yellow-500', text: 'Connecting...' },
            live: { color: 'bg-green-500', text: 'Live' },
            stale: { color: 'bg-orange-500', text: 'Delayed' },
            disconnected: { color: 'bg-red-500', text: 'Disconnected' },
        };
        const { color, text } = statusConfig[status] || statusConfig.disconnected;
        return (
            <div className="status-indicator" title={`Data feed status: ${text}`}>
                <div className={`status-dot ${color}`}></div>
                <span className="text-sm font-semibold text-gray-700">{text}</span>
            </div>
        );
    };

    const Search = ({ onStopSelect }) => {
        const [query, setQuery] = useState('');
        const [results, setResults] = useState([]);
        const [loading, setLoading] = useState(false);

        useEffect(() => {
            if (query.length < 3) {
                setResults([]);
                return;
            }
            const debounce = setTimeout(() => {
                setLoading(true);
                fetch(`/api/stops/search?q=${query}`)
                    .then(res => res.json())
                    .then(data => {
                        setResults(data);
                        setLoading(false);
                    })
                    .catch(() => setLoading(false));
            }, 300);
            return () => clearTimeout(debounce);
        }, [query]);

        const handleSelect = (stop) => {
            onStopSelect(stop);
            setQuery('');
            setResults([]);
        }

        return (
            <div className="absolute top-4 left-1/2 -translate-x-1/2 z-[1000] w-full max-w-md px-4">
                <div className="relative">
                    <input
                        type="text"
                        value={query}
                        onChange={e => setQuery(e.target.value)}
                        placeholder="Search for a bus stop..."
                        className="w-full px-4 py-2 text-gray-800 bg-white rounded-full shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    {results.length > 0 && (
                        <ul className="absolute w-full mt-2 bg-white rounded-lg shadow-xl overflow-hidden">
                            {results.map(stop => (
                                <li key={stop.stopId} onClick={() => handleSelect(stop)}
                                    className="px-4 py-2 cursor-pointer hover:bg-gray-100">
                                    {stop.stopName}
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            </div>
        )
    }

    // --- Main App Component ---
    const App = () => {
        const [vehicles, setVehicles] = useState({});
        const [allStops, setAllStops] = useState([]);
        const [sidebarView, setSidebarView] = useState('hidden');
        const [connectionStatus, setConnectionStatus] = useState('connecting');

        const [selectedVehicle, setSelectedVehicle] = useState(null);
        const [selectedStop, setSelectedStop] = useState(null);

        const [tripSchedule, setTripSchedule] = useState({ loading: false, data: [] });
        const [routesForStop, setRoutesForStop] = useState({ loading: false, data: [] });
        const [routePath, setRoutePath] = useState([]);
        const lastUpdateRef = useRef(null);
        const mapRef = useRef(null);

        useEffect(() => {
            fetch('/api/stops/all')
                .then(res => res.json())
                .then(setAllStops)
                .catch(err => console.error("Failed to fetch stops:", err));
        }, []);

        useEffect(() => {
            // SSE connection logic remains the same
            let eventSource;
            let reconnectTimeout;

            function connect() {
                eventSource = new EventSource('/vehicles');
                setConnectionStatus('connecting');
                eventSource.onopen = () => setConnectionStatus('live');
                eventSource.onmessage = e => {
                    const eventData = JSON.parse(e.data);
                    if (eventData.type === 'vehicles') {
                        setVehicles(prev => {
                            const updated = { ...prev };
                            eventData.payload.forEach(v => { updated[v.vehicleId] = v; });
                            return updated;
                        });
                        lastUpdateRef.current = Date.now();
                        if (connectionStatus !== 'live') setConnectionStatus('live');
                    }
                };
                eventSource.addEventListener('heartbeat', () => {
                    lastUpdateRef.current = Date.now();
                    if (connectionStatus !== 'live') setConnectionStatus('live');
                });
                eventSource.onerror = () => {
                    setConnectionStatus('disconnected');
                    eventSource.close();
                    reconnectTimeout = setTimeout(connect, 5000);
                };
            }

            connect();

            const staleCheckInterval = setInterval(() => {
                if (lastUpdateRef.current && (Date.now() - lastUpdateRef.current > 45000)) {
                   if (connectionStatus === 'live') setConnectionStatus('stale');
                }
            }, 10000);

            return () => {
                if (eventSource) eventSource.close();
                clearTimeout(reconnectTimeout);
                clearInterval(staleCheckInterval);
            };
        }, [connectionStatus]);

        const handleSelectVehicle = useCallback((vehicle) => {
            setSelectedVehicle(vehicle);
            setSelectedStop(null);
            setSidebarView('vehicle-details');
            setTripSchedule({ loading: true, data: [] });
            setRoutePath([]);
            if (vehicle.tripId) {
                // CORRECTED: This now points to the correct, existing endpoint in GtfsController.
                fetch(`/api/trips/${vehicle.tripId}/schedule`)
                    .then(res => res.json())
                    .then(data => setTripSchedule({ loading: false, data: data }))
                    .catch(() => setTripSchedule({ loading: false, data: [] }));
            }
            if (vehicle.routeId) {
                 fetch(`/api/routes/${vehicle.routeId}/path`)
                    .then(res => res.json())
                    .then(setRoutePath)
                    .catch(err => console.error("Failed to fetch route path", err));
            }
        }, []);

        const handleSelectStop = useCallback((stop) => {
            setSelectedStop(stop);
            setSelectedVehicle(null);
            setSidebarView('stop-details');
            setRoutesForStop({ loading: true, data: [] });
            setRoutePath([]);
            fetch(`/api/stops/${stop.stopId}/routes`)
                .then(res => res.json())
                .then(data => setRoutesForStop({ loading: false, data }))
                .catch(() => setRoutesForStop({ loading: false, data: [] }));

            if (mapRef.current) {
                mapRef.current.setView([stop.stopLat, stop.stopLon], 16);
            }
        }, []);

        const handleSelectRouteFromStop = useCallback((route) => {
            fetch(`/api/routes/${route.routeId}/path`)
                .then(res => res.json())
                .then(setRoutePath)
                .catch(err => console.error("Failed to fetch route path for stop", err));
        }, []);

        const clearSelection = () => {
            setSelectedVehicle(null);
            setSelectedStop(null);
            setSidebarView('hidden');
            setRoutePath([]);
            setTripSchedule({ loading: false, data: [] });
            setRoutesForStop({ loading: false, data: [] });
        };

        const vehicleList = useMemo(() => Object.values(vehicles), [vehicles]);

        return (
            <div className="relative h-screen w-screen">
                <Sidebar
                    view={sidebarView} vehicle={selectedVehicle} stop={selectedStop}
                    tripSchedule={tripSchedule} routesForStop={routesForStop}
                    onSelectRoute={handleSelectRouteFromStop} onClear={clearSelection}
                />
                 <Search onStopSelect={handleSelectStop} />
                <MapComponent
                    mapRef={mapRef}
                    vehicles={vehicleList} allStops={allStops}
                    onSelectVehicle={handleSelectVehicle} onSelectStop={handleSelectStop}
                    selectedVehicle={selectedVehicle}
                    routePath={routePath} tripScheduleStops={tripSchedule.data}
                    selectedStop={selectedStop}
                />
                <StatusIndicator status={connectionStatus} />
            </div>
        );
    };

    // --- Fare Calculator ---
    const FareCalculator = ({ fromStop, route }) => {
        const [destinationStops, setDestinationStops] = useState([]);
        const [selectedDest, setSelectedDest] = useState('');
        const [fare, setFare] = useState(null);
        const [loading, setLoading] = useState(false);

        useEffect(() => {
            if (route) {
                fetch(`/api/routes/${route.routeId}/path`)
                    .then(res => res.json())
                    .then(stops => setDestinationStops(stops))
                    .catch(() => setDestinationStops([]));
            }
        }, [route]);

        const handleCalculate = () => {
            if (!selectedDest || !fromStop || !route) return;
            setLoading(true);
            setFare(null);
            fetch(`/api/fare?routeId=${route.routeId}&fromStopId=${fromStop.stopId}&toStopId=${selectedDest}`)
                .then(res => res.ok ? res.json() : Promise.reject('No fare found'))
                .then(data => {
                    setFare(data.price !== null ? `₹${data.price}`: 'Not available');
                    setLoading(false);
                })
                .catch(() => {
                    setFare('Not available');
                    setLoading(false);
                });
        };

        return (
            <div className="mt-4 p-4 border-t">
                <h4 className="font-semibold text-gray-700 mb-2">Fare Calculator</h4>
                <p className="text-sm mb-2">Route: <span className="font-bold">{route.routeShortName}</span></p>
                <div className="space-y-3">
                    <select
                        value={selectedDest}
                        onChange={e => setSelectedDest(e.target.value)}
                        className="w-full p-2 border rounded-md bg-white text-sm"
                    >
                        <option value="">Select destination stop</option>
                        {destinationStops.filter(s => s.stopId !== fromStop.stopId).map(s => (
                            <option key={s.stopId} value={s.stopId}>{s.stopName}</option>
                        ))}
                    </select>
                    <button onClick={handleCalculate} disabled={!selectedDest || loading} className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 disabled:bg-gray-400">
                        {loading ? 'Calculating...' : 'Get Fare'}
                    </button>
                    {fare && <p className="text-center font-bold text-lg mt-2">Fare: {fare}</p>}
                </div>
            </div>
        );
    };


    // --- Sidebar Component ---
    const Sidebar = ({ view, vehicle, stop, tripSchedule, routesForStop, onSelectRoute, onClear }) => {
        const isVisible = view !== 'hidden';
        const [selectedRouteForFare, setSelectedRouteForFare] = useState(null);

        const title = view === 'vehicle-details' ? `Route ${vehicle?.routeName || 'N/A'}` :
                      view === 'stop-details' ? `Stop Details` : 'Details';

        const handleRouteSelect = (route) => {
            onSelectRoute(route);
            setSelectedRouteForFare(route);
        }

        return (
            <div className={`sidebar absolute top-0 left-0 h-full w-80 md:w-96 bg-white shadow-lg z-[1000] transform ${isVisible ? 'translate-x-0' : '-translate-x-full'}`}>
                <div className="flex flex-col h-full">
                    <div className="p-4 border-b flex justify-between items-center">
                        <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                        <button onClick={onClear} className="p-1 rounded-full hover:bg-gray-200" aria-label="Close details">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                    <div className="flex-1 overflow-y-auto sidebar-content">
                        {view === 'vehicle-details' && (
                            <>
                                <div className="p-4 bg-gray-50 border-b">
                                    <p className="text-sm text-gray-600">Vehicle ID</p>
                                    <p className="font-mono text-gray-800">{vehicle?.vehicleId}</p>
                                    <p className="text-sm text-gray-600 mt-2">Trip Headsign</p>
                                    <p className="font-semibold text-gray-800">{vehicle?.tripHeadsign || "Not available"}</p>
                                </div>
                                {tripSchedule.loading ? <div className="flex justify-center p-8"><div className="loader"></div></div> :
                                 !tripSchedule.data || tripSchedule.data.length === 0 ? <p className="p-4 text-gray-500">No schedule found for this trip.</p> :
                                <ul>
                                    {tripSchedule.data.map((item, index) => (
                                        <li key={index} className="border-b p-3 flex items-center">
                                            <div className="text-sm font-semibold text-gray-600 w-16">{item?.departureTime?.substring(0,5)}</div>
                                            <div className="pl-3 border-l-2 border-gray-300">
                                                <p className="font-medium text-gray-800">{item?.stopName}</p>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                                }
                            </>
                        )}
                         {view === 'stop-details' && (
                            <>
                                <h3 className="p-4 font-bold text-lg text-gray-800">{stop?.stopName}</h3>
                                {routesForStop.loading ? <div className="flex justify-center p-8"><div className="loader"></div></div> :
                                 !routesForStop.data || routesForStop.data.length === 0 ? <p className="p-4 text-gray-500">No routes found for this stop.</p> :
                                <ul className="px-2">
                                    {routesForStop.data.map(route => (
                                        <li key={route.routeId}>
                                            <button onClick={() => handleRouteSelect(route)} className="w-full text-left p-2.5 my-1 rounded-lg hover:bg-gray-100 focus:bg-blue-100 focus:outline-none transition-colors">
                                                <span className="font-bold bg-blue-600 text-white rounded px-2 py-1 text-sm w-14 inline-block text-center mr-3">{route.routeShortName}</span>
                                                <span className="text-sm text-gray-700">{route.routeLongName}</span>
                                            </button>
                                        </li>
                                    ))}
                                </ul>
                                }
                                {selectedRouteForFare && <FareCalculator fromStop={stop} route={selectedRouteForFare} />}
                            </>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    // --- Map Component ---
    const MapComponent = ({ mapRef, vehicles, allStops, onSelectVehicle, onSelectStop, selectedVehicle, routePath, tripScheduleStops, selectedStop }) => {
        const vehicleMarkersRef = useRef({});
        const stopMarkersRef = useRef({});
        const routeLayerRef = useRef(null);
        const stopsLayerRef = useRef(null); // Changed to marker cluster group

        useEffect(() => {
            if (!mapRef.current) {
                mapRef.current = L.map('map', { zoomControl: false }).setView([28.6139, 77.2090], 12);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO' }).ad(mapRef.current);
                L.control.zoom({ position: 'topright' }).ad(mapRef.current);
                routeLayerRef.current = L.layerGroup().ad(mapRef.current);
                stopsLayerRef.current = L.markerClusterGroup({
                     chunkedLoading: true,
                     maxClusterRadius: 60,
                     disableClusteringAtZoom: 15
                }).ad(mapRef.current);
            }
        }, []);

        useEffect(() => {
            stopsLayerRef.current.clearLayers();
            const stopMarkers = allStops.map(stop => {
                const marker = L.marker([stop.stopLat, stop.stopLon], {
                    icon: L.divIcon({ className: 'stop-marker-icon', iconSize: [8, 8] }), zIndexOffset: 100
                }).on('click', () => onSelectStop(stop));
                stopMarkersRef.current[stop.stopId] = marker;
                return marker;
            });
            stopsLayerRef.current.addLayers(stopMarkers);
        }, [allStops, onSelectStop]);


        useEffect(() => {
            const tripStopIds = new Set(tripScheduleStops.map(s => s?.stopId));
             Object.entries(stopMarkersRef.current).forEach(([id, marker]) => {
                let className = 'stop-marker-icon';
                if (selectedStop?.stopId === id) className += ' selected';
                else if (tripStopIds.has(id)) className += ' highlighted';
                marker.setIcon(L.divIcon({ className, iconSize: [8, 8] }));
            });
        }, [tripScheduleStops, selectedStop]);


        useEffect(() => {
            routeLayerRef.current.clearLayers();
            if (routePath && routePath.length > 0) {
                const latLngs = routePath.map(p => [p.stopLat, p.stopLon]);
                const polyline = L.polyline(latLngs, { color: '#1a73e8', weight: 5, opacity: 0.7 });
                routeLayerRef.current.addLayer(polyline);
                if (mapRef.current && latLngs.length > 0) {
                    mapRef.current.fitBounds(L.latLngBounds(latLngs).pad(0.1));
                }
            }
        }, [routePath]);

        useEffect(() => {
            const vehicleIdsOnMap = new Set(Object.keys(vehicleMarkersRef.current));
            vehicles.forEach(vehicle => {
                const { vehicleId, lat, lon, routeName } = vehicle;
                vehicleIdsOnMap.delete(vehicleId);
                const isSelected = selectedVehicle?.vehicleId === vehicleId;
                const iconHtml = `<div>${routeName || ''}</div>`;
                const iconClassName = `bus-marker ${isSelected ? 'selected' : ''}`;
                const busIcon = L.divIcon({ className: iconClassName, html: iconHtml, iconSize: [32, 32] });

                if (vehicleMarkersRef.current[vehicleId]) {
                    vehicleMarkersRef.current[vehicleId].setLatLng([lat, lon]).setIcon(busIcon);
                } else {
                    const newMarker = L.marker([lat, lon], { icon: busIcon, zIndexOffset: 1000 })
                        .on('click', () => onSelectVehicle(vehicle))
                        .ad(mapRef.current);
                    vehicleMarkersRef.current[vehicleId] = newMarker;
                }
            });
            // remove vehicles that are no longer in the feed
            vehicleIdsOnMap.forEach(id => {
                if(vehicleMarkersRef.current[id]) {
                    vehicleMarkersRef.current[id].remove();
                    delete vehicleMarkersRef.current[id];
                }
            })

        }, [vehicles, onSelectVehicle, selectedVehicle]);

        return <div id="map" className="h-full w-full z-0"></div>;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>

