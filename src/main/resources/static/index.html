<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delhi Live Bus Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f4f5; color: #18181b; display: flex; overflow: hidden;
        }
        #map { height: 100%; flex-grow: 1; z-index: 1; }
        .sidebar {
            width: 350px; height: 100%; background-color: #ffffff;
            border-left: 1px solid #e4e4e7; z-index: 1000; display: flex;
            flex-direction: column; box-shadow: -2px 0 10px rgba(0,0,0,0.05);
        }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid #e4e4e7; }
        .sidebar-header h1 { margin: 0; font-size: 1.5rem; font-weight: 700; }
        #status { font-size: 0.875rem; color: #71717a; margin-top: 0.5rem; }
        .sidebar-content { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }
        .accordion-item { border-bottom: 1px solid #e4e4e7; }
        .accordion-button {
            width: 100%; background: none; border: none; text-align: left; padding: 1rem 0;
            font-size: 1rem; font-weight: 600; cursor: pointer; display: flex;
            justify-content: space-between; align-items: center;
        }
        .accordion-button:hover { background-color: #fafafa; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; padding-bottom: 0; }
        .accordion-content.active { padding-bottom: 1rem; }
        .data-list, #selected-vehicle-details { font-size: 0.875rem; color: #3f3f46; }
        .data-list p, #selected-vehicle-details p { margin: 0.5rem 0; line-height: 1.5; }
        .data-list strong, #selected-vehicle-details strong { color: #18181b; }
        .leaflet-popup-content-wrapper { background: #ffffff; color: #18181b; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.15);}
        .leaflet-popup-tip { background: #ffffff; }
        .popup-table { width: 100%; border-collapse: collapse; }
        .popup-table td { padding: 4px 0; }
        .popup-table td:first-child { font-weight: 500; padding-right: 15px; color: #71717a; }
        .leaflet-control-layers {
             background: #ffffff !important; border: 1px solid #d4d4d8 !important;
             border-radius: 8px !important; color: #18181b !important;
        }
        #selected-vehicle-info { padding-top: 1.5rem; border-top: 1px solid #e4e4e7; }
        #selected-vehicle-info h2 { margin-top: 0; }
        #stop-list { list-style: none; padding-left: 0; max-height: 200px; overflow-y: auto;}
        #stop-list li { padding: 0.25rem 0; }
    </style>
</head>
<body>
<div id="map"></div>
<div class="sidebar">
    <div class="sidebar-header">
        <h1>Delhi Bus Tracker</h1>
        <p id="status">Initializing...</p>
    </div>
    <div class="sidebar-content">
        <div id="selected-vehicle-info" style="display: none;">
            <h2>Selected Bus Details</h2>
            <div id="selected-vehicle-details"></div>
        </div>

        <h2>Static Data Explorer</h2>
        <div class="accordion-item">
            <button class="accordion-button" data-target="agency-content">Agency Info <span class="icon">+</span></button>
            <div id="agency-content" class="accordion-content">
                <div id="agency-data" class="data-list">Loading...</div>
            </div>
        </div>
        <div class="accordion-item">
            <button class="accordion-button" data-target="calendar-content">Service Calendars <span class="icon">+</span></button>
            <div id="calendar-content" class="accordion-content">
                <div id="calendar-data" class="data-list">Loading...</div>
            </div>
        </div>
        <!-- ** REMOVED: Fare accordion that loaded all data and caused crash ** -->
    </div>
</div>

<script>
    const map = L.map('map').setView([28.6139, 77.2090], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd', maxZoom: 20
    }).addTo(map);

    const busIcon = L.divIcon({
        html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28" fill="#1e40af"><path d="M18.9,8.2h-1.3V6.8c0-1.2-1-2.2-2.2-2.2H8.6c-1.2,0-2.2,1-2.2,2.2v1.4H5.1C4.5,8.2,4,8.7,4,9.3v8.3c0,0.6,0.5,1.1,1.1,1.1h1.3 c0.2,0.8,1,1.4,1.9,1.4s1.7-0.6,1.9-1.4h4.4c0.2,0.8,1,1.4,1.9,1.4s1.7-0.6,1.9-1.4h1.3c0.6,0,1.1-0.5,1.1-1.1V9.3 C20,8.7,19.5,8.2,18.9,8.2z M8.6,6.8h6.8v1.4H8.6V6.8z M8.3,18.7c-0.6,0-1.1-0.5-1.1-1.1s0.5-1.1,1.1-1.1s1.1,0.5,1.1,1.1 S8.9,18.7,8.3,18.7z M15.7,18.7c-0.6,0-1.1-0.5-1.1-1.1s0.5-1.1,1.1-1.1s1.1,0.5,1.1,1.1S16.3,18.7,15.7,18.7z M18.9,16.5h-0.8 c-0.2-1.6-1.5-2.8-3.2-2.8h-6c-1.7,0-3,1.2-3.2,2.8H5.1V9.3h13.8V16.5z"/></svg>`,
        className: '', iconSize: [28, 28], iconAnchor: [14, 14], popupAnchor: [0, -14]
    });
    const stopIcon = L.divIcon({
        html: `<div style="background-color: #64748b; width: 8px; height: 8px; border-radius: 50%; border: 1px solid #f8fafc;"></div>`,
        className: '', iconSize: [10, 10], iconAnchor: [5, 5]
    });

    let vehicleMarkers = {};
    let allStops = {};
    let currentRoutePolyline = null;

    const busLayerGroup = L.layerGroup().addTo(map);
    const stopLayerGroup = L.layerGroup();
    L.control.layers(null, { "Buses": busLayerGroup, "Bus Stops": stopLayerGroup }, { position: 'topright' }).addTo(map);

    function formatOccupancy(status) {
        if (!status) return 'Unknown';
        return status.toLowerCase().replace(/_/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }

    function updateMap(vehicles) {
        const statusElement = document.getElementById('status');
        const now = new Date();
        statusElement.textContent = `Tracking ${vehicles.length} active buses. Last updated: ${now.toLocaleTimeString()}`;
        const receivedVehicleIds = new Set(vehicles.map(v => v.vehicleId || v.tripId));

        vehicles.forEach(vehicle => {
            const vehicleId = vehicle.vehicleId || vehicle.tripId;
            if (!vehicleId || !vehicle.lat || !vehicle.lon) return;

            const speedText = vehicle.speed > 0.5 ? `${vehicle.speed.toFixed(1)} km/h` : 'Stationary';
            const occupancyText = formatOccupancy(vehicle.occupancyStatus);
            const vehicleCategoryText = vehicle.vehicleCategory || 'Standard Bus';
            const popupContent = `<table class="popup-table"><tr><td>Route:</td><td>${vehicle.routeName || 'Info unavailable'}</td></tr><tr><td>Vehicle:</td><td>${vehicle.vehicleId || 'N/A'}</td></tr><tr><td>Type:</td><td>${vehicleCategoryText}</td></tr><tr><td>Occupancy:</td><td>${occupancyText}</td></tr></table><p style="text-align:center; margin-top: 5px; font-size: 0.8em;">Click for route details</p>`;

            let marker;
            if (vehicleMarkers[vehicleId]) {
                marker = vehicleMarkers[vehicleId];
                marker.setLatLng([vehicle.lat, vehicle.lon]);
                marker.getPopup().setContent(popupContent);
            } else {
                marker = L.marker([vehicle.lat, vehicle.lon], { icon: busIcon }).bindPopup(popupContent).addTo(busLayerGroup);
                vehicleMarkers[vehicleId] = marker;
            }
            marker.off('click').on('click', () => {
                displayVehicleRouteAndDetails(vehicle);
            });
        });

        Object.keys(vehicleMarkers).forEach(id => {
            if (!receivedVehicleIds.has(id)) {
                if (map.hasLayer(vehicleMarkers[id])) map.removeLayer(vehicleMarkers[id]);
                delete vehicleMarkers[id];
            }
        });
    }

    async function displayVehicleRouteAndDetails(vehicle) {
        if (currentRoutePolyline) {
            map.removeLayer(currentRoutePolyline);
        }

        try {
            const response = await fetch(`/api/route-stops/${vehicle.tripId}`);
            if (response.ok) {
                const routeStops = await response.json();
                const latLngs = routeStops.map(s => [s.stopLat, s.stopLon]);
                if (latLngs.length > 1) {
                    currentRoutePolyline = L.polyline(latLngs, { color: '#0284c7', weight: 4 }).addTo(map);
                    map.fitBounds(currentRoutePolyline.getBounds().pad(0.1));
                }
            }
        } catch (error) {
            console.error('Failed to fetch route stops data:', error);
        }

        const detailsContainer = document.getElementById('selected-vehicle-details');
        const infoContainer = document.getElementById('selected-vehicle-info');
        infoContainer.style.display = 'block';
        // ** UPDATED: Added placeholder for fare info **
        detailsContainer.innerHTML = `<p><strong>Route:</strong> ${vehicle.routeName || 'N/A'}</p><p><strong>Vehicle:</strong> ${vehicle.vehicleId || 'N/A'}</p><div id="selected-vehicle-fares"></div><h4>Stops:</h4><ul id="stop-list"><li>Loading stops...</li></ul>`;

        // ** NEW: Fetch and display fares for the selected route **
        if (vehicle.routeId) {
            try {
                const faresResponse = await fetch(`/api/fares/${vehicle.routeId}`);
                const faresContainer = document.getElementById('selected-vehicle-fares');
                if (faresResponse.ok) {
                    const fares = await faresResponse.json();
                    faresContainer.innerHTML = '<h4>Fares:</h4>' + fares.map(f => `<p><strong>Price:</strong> ${f.price} ${f.currencyType}</p>`).join('');
                } else {
                    faresContainer.innerHTML = '<h4>Fares:</h4><p>Not available for this route.</p>';
                }
            } catch (error) {
                document.getElementById('selected-vehicle-fares').innerHTML = '<h4>Fares:</h4><p>Could not load fare data.</p>';
            }
        }


        try {
            const stopsResponse = await fetch(`/api/stop-times/${vehicle.tripId}`);
            if(stopsResponse.ok) {
                const stopTimes = await stopsResponse.json();
                const stopList = document.getElementById('stop-list');
                stopList.innerHTML = stopTimes
                    .map(st => `<li>${allStops[st.stopId] ? allStops[st.stopId].stopName : 'Unknown Stop'}</li>`)
                    .join('');
            } else {
                 document.getElementById('stop-list').innerHTML = '<li>Stop information unavailable.</li>';
            }
        } catch (error) {
             document.getElementById('stop-list').innerHTML = '<li>Could not load stop information.</li>';
        }
    }


    async function fetchData(endpoint, elementId, formatter) {
        const element = document.getElementById(elementId);
        try {
            const response = await fetch(endpoint);
            if (!response.ok) { element.innerHTML = `<p>Error loading data.</p>`; return; }
            const data = await response.json();
            element.innerHTML = formatter(data);
        } catch (error) {
            console.error(`Failed to fetch from ${endpoint}:`, error);
            element.innerHTML = `<p>Error loading data.</p>`;
        }
    }

    function formatAgency(agencies) { return agencies.map(a => `<p><strong>${a.agencyName}</strong><br>Timezone: ${a.agencyTimezone}<br>Website: <a href="${a.agencyUrl}" target="_blank">${a.agencyUrl}</a></p>`).join(''); }
    function formatCalendar(calendars) { return calendars.map(cal => { const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].filter((day, i) => [cal.monday, cal.tuesday, cal.wednesday, cal.thursday, cal.friday, cal.saturday, cal.sunday][i]).join(', '); return `<p><strong>Service ID:</strong> ${cal.serviceId}<br><strong>Runs on:</strong> ${days}<br><strong>Period:</strong> ${cal.startDate} to ${cal.endDate}</p>` }).slice(0, 5).join('') + '<p>... and more.</p>'; }

    async function loadStops() {
        try {
            const response = await fetch('/api/stops');
            const stops = await response.json();
            stops.forEach(stop => {
                allStops[stop.stopId] = stop;
                L.marker([stop.stopLat, stop.stopLon], { icon: stopIcon })
                 .bindPopup(stop.stopName)
                 .addTo(stopLayerGroup);
            });
        } catch (error) {
            console.error('Failed to fetch stops:', error);
        }
    }

    async function fetchVehicleData() {
        try {
            const response = await fetch('/api/vehicles');
            if (!response.ok) return;
            const vehicles = await response.json();
            updateMap(vehicles);
        } catch (error) {
            console.error('Failed to fetch vehicle data:', error);
        }
    }

    document.querySelectorAll('.accordion-button').forEach(button => {
        button.addEventListener('click', () => {
            const content = document.getElementById(button.dataset.target);
            const icon = button.querySelector('.icon');
            content.classList.toggle('active');
            if (content.classList.contains('active')) {
                content.style.maxHeight = content.scrollHeight + "px";
                icon.textContent = '-';
            } else {
                content.style.maxHeight = 0;
                icon.textContent = '+';
            }
        });
    });

    // Initial data fetch
    fetchVehicleData();
    loadStops();
    fetchData('/api/agencies', 'agency-data', formatAgency);
    fetchData('/api/calendars', 'calendar-data', formatCalendar);
    setInterval(fetchVehicleData, 15000);
</script>
</body>
</html>

